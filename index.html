<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åç‰‡æœé›†å™¨ (æ­£å¼ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6">
        <h1 class="text-2xl font-bold mb-4 text-center text-gray-800">åç‰‡æœé›†å™¨</h1>

        <div class="mb-4 text-center">
            <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
            <label for="cameraInput" class="cursor-pointer bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded block w-full">
                ğŸ“· æ‹æ”æˆ–ä¸Šå‚³åç‰‡
            </label>
            <img id="preview" class="mt-4 w-full h-auto rounded hidden border border-gray-300" />
        </div>

        <div id="status" class="text-center text-sm text-gray-600 mb-4 h-6 font-bold">ç­‰å¾…åœ–ç‰‡...</div>

        <form id="cardForm" class="space-y-3">
            <div>
                <label class="block text-sm font-medium text-gray-700">å§“å</label>
                <input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 bg-gray-50" placeholder="ç­‰å¾…è¾¨è­˜...">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">å…¬å¸åç¨±</label>
                <input type="text" id="company" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 bg-gray-50">
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700">é›»è©± 1</label>
                    <input type="text" id="phone1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">é›»è©± 2</label>
                    <input type="text" id="phone2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 bg-gray-50">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 bg-gray-50">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">å‚™è¨»</label>
                <textarea id="remarks" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="åœ¨æ­¤è¼¸å…¥æ‹œè¨ªç´€éŒ„..."></textarea>
            </div>

            <input type="hidden" id="imageBase64">
            <textarea id="rawText" class="hidden"></textarea>

            <button type="button" onclick="submitData()" id="saveBtn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                â˜ï¸ å„²å­˜åˆ° Google é›²ç«¯
            </button>
        </form>
    </div>

    <script>
        // âš ï¸âš ï¸âš ï¸ è«‹å‹™å¿…å°‡ä¸‹æ–¹ç¶²å€æ›æˆä½ çš„ Google Apps Script ç¶²å€ âš ï¸âš ï¸âš ï¸
        const SCRIPT_URL = https://script.google.com/macros/s/AKfycbxSOgmMhUVUfvurWEoAdtO6sMqNYrSQ1adFTdLRGpYBrKEsOq3bx98FvxiEk0oeit6V/exec;

        const cameraInput = document.getElementById('cameraInput');
        const preview = document.getElementById('preview');
        const statusDiv = document.getElementById('status');
        
        cameraInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // é¡¯ç¤ºåœ–ç‰‡
            const reader = new FileReader();
            reader.onload = function(event) {
                preview.src = event.target.result;
                preview.classList.remove('hidden');
                document.getElementById('imageBase64').value = event.target.result;
            };
            reader.readAsDataURL(file);

            // é–‹å§‹ OCR
            statusDiv.innerHTML = '<div class="loading-spinner"></div>æ­£åœ¨å•Ÿå‹•è¾¨è­˜å¼•æ“(é¦–æ¬¡è¼‰å…¥ç´„éœ€10ç§’)...';
            
            try {
                // å»ºç«‹ Worker
                const worker = await Tesseract.createWorker('chi_tra+eng', 1, {
                    logger: m => {
                        if(m.status === 'recognizing text') {
                            statusDiv.innerHTML = `<div class="loading-spinner"></div>è¾¨è­˜ä¸­... ${Math.round(m.progress * 100)}%`;
                        } else {
                            statusDiv.innerHTML = `<div class="loading-spinner"></div>ç³»çµ±ç‹€æ…‹: ${m.status}`;
                        }
                    }
                });

                // åŸ·è¡Œè¾¨è­˜
                const result = await worker.recognize(file);
                const text = result.data.text;
                
                // è¾¨è­˜å®Œæˆ
                await worker.terminate();
                statusDiv.innerText = 'âœ… è¾¨è­˜å®Œæˆï¼è«‹æª¢æŸ¥ä¸¦è£œå……è³‡æ–™ã€‚';
                document.getElementById('rawText').value = text;
                
                parseCardData(text);

            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = '<span style="color:red">âŒ è¾¨è­˜å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šã€‚</span>';
                alert('éŒ¯èª¤è©³æƒ…ï¼š' + error.message);
            }
        });

        // è§£æè³‡æ–™é‚è¼¯
        function parseCardData(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const emailRegex = /[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}/;
            const emailMatch = text.match(emailRegex);
            if (emailMatch) document.getElementById('email').value = emailMatch[0];

            const phoneRegex = /(?:\+?886|09|02|04)[0-9\-\s\(\)]{7,}/g;
            const phones = text.match(phoneRegex);
            if (phones) {
                if(phones[0]) document.getElementById('phone1').value = phones[0].trim();
                if(phones[1]) document.getElementById('phone2').value = phones[1].trim();
            }

            let nameFound = false;
            let companyFound = false;
            lines.forEach(line => {
                if (line.includes('@') || line.includes('http')) return;
                if (!companyFound && (line.includes('å…¬å¸') || line.includes('Co.') || line.includes('Ltd') || line.includes('Inc'))) {
                    document.getElementById('company').value = line.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s\.\,]/g, '').trim();
                    companyFound = true;
                } else if (!nameFound && line.length > 1 && line.length < 10 && !line.match(/[0-9]/)) {
                    document.getElementById('name').value = line.replace(/[^\u4e00-\u9fa5a-zA-Z\s]/g, '').trim();
                    nameFound = true;
                }
            });
        }

        // ä¸Šå‚³åŠŸèƒ½
        function submitData() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerText;
            
            if(!document.getElementById('imageBase64').value) {
                alert("è«‹å…ˆä¸Šå‚³åç‰‡åœ–ç‰‡ï¼");
                return;
            }

            btn.disabled = true;
            btn.innerText = 'â³ è³‡æ–™ä¸Šå‚³ä¸­...';

            const data = {
                image: document.getElementById('imageBase64').value,
                fileName: `card_${Date.now()}.png`,
                name: document.getElementById('name').value,
                company: document.getElementById('company').value,
                phone1: document.getElementById('phone1').value,
                phone2: document.getElementById('phone2').value,
                email: document.getElementById('email').value,
                remarks: document.getElementById('remarks').value,
                rawText: document.getElementById('rawText').value
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(response => {
                alert('ğŸ‰ è³‡æ–™å·²æˆåŠŸå„²å­˜åˆ°é›²ç«¯ï¼');
                btn.disabled = false;
                btn.innerText = originalText;
                document.getElementById('cardForm').reset();
                document.getElementById('preview').classList.add('hidden');
                document.getElementById('status').innerText = 'ç­‰å¾…åœ–ç‰‡...';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Script ç¶²å€æˆ–ç¶²è·¯ã€‚');
                btn.disabled = false;
                btn.innerText = originalText;
            });
        }
    </script>
</body>
</html>
