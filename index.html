<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI åç‰‡æƒæå™¨ (Geminiç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* éš±è—é è¨­çš„æª”æ¡ˆä¸Šå‚³é†œé†œçš„æŒ‰éˆ• */
        .hidden { display: none; }
        /* è¼‰å…¥å‹•ç•« */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden p-6">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">AI åç‰‡æƒæå™¨ ğŸ¤–</h1>

        <div class="mb-6 flex justify-center">
            <div class="relative w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-400">
                <img id="preview" class="hidden w-full h-full object-contain" alt="åç‰‡é è¦½">
                <span id="placeholder-text" class="text-gray-500">å°šæœªé¸æ“‡åœ–ç‰‡</span>
            </div>
        </div>

        <div id="ocr-status" class="text-center text-sm text-blue-600 font-medium mb-4 h-6">
            è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ‹æ”æˆ–ä¸Šå‚³
        </div>

        <label for="cameraInput" class="block w-full bg-indigo-600 text-white text-center font-bold py-3 px-4 rounded-lg cursor-pointer hover:bg-indigo-700 transition shadow-md mb-6">
            ğŸ“· æ‹æ” / é¸æ“‡åç‰‡
        </label>
        <input type="file" id="cameraInput" accept="image/*" class="hidden">
        <input type="hidden" id="imageBase64">

        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-1">å§“å (Name)</label>
                <input type="text" id="name" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-indigo-500" placeholder="AI è‡ªå‹•è¾¨è­˜...">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-1">å…¬å¸ (Company)</label>
                <input type="text" id="company" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-indigo-500" placeholder="AI è‡ªå‹•è¾¨è­˜...">
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-1">é›»è©± 1</label>
                    <input type="text" id="phone1" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-1">é›»è©± 2</label>
                    <input type="text" id="phone2" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-indigo-500">
                </div>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-1">Email</label>
                <input type="email" id="email" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-indigo-500">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-1">å‚™è¨» (Remarks)</label>
                <textarea id="remarks" rows="2" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-indigo-500" placeholder="è‡ªè¡Œè¼¸å…¥å‚™è¨»..."></textarea>
            </div>
        </div>

        <div class="mt-6">
            <button id="analyzeBtn" onclick="analyzeImage()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                ğŸ” é–‹å§‹ AI è¾¨è­˜
            </button>

            <button id="saveBtn" onclick="saveFinalData()" class="hidden w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">
                âœ… ç¢ºèªç„¡èª¤ä¸¦å„²å­˜
            </button>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        // è«‹å°‡ä¸‹æ–¹ç¶²å€æ›æˆä½ çš„ Google Apps Script éƒ¨ç½²ç¶²å€ (çµå°¾æ˜¯ /exec)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxSOgmMhUVUfvurWEoAdtO6sMqNYrSQ1adFTdLRGpYBrKEsOq3bx98FvxiEk0oeit6V/exec';
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const cameraInput = document.getElementById('cameraInput');
        const preview = document.getElementById('preview');
        const placeholder = document.getElementById('placeholder-text');
        
        // å…¨åŸŸè®Šæ•¸ï¼Œç”¨ä¾†æš«å­˜ AI éšæ®µç”¢ç”Ÿçš„åœ–ç‰‡é€£çµ
        let currentFileUrl = "";

        // ç›£è½åœ–ç‰‡é¸æ“‡äº‹ä»¶
        cameraInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // é¡¯ç¤ºåœ–ç‰‡é è¦½
            const reader = new FileReader();
            reader.onload = function(event) {
                preview.src = event.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                document.getElementById('imageBase64').value = event.target.result;
                
                // é‡ç½®ä»‹é¢ç‹€æ…‹
                document.getElementById('ocr-status').innerText = 'ğŸ“¸ åœ–ç‰‡å·²å°±ç·’ï¼Œè«‹æŒ‰ã€ŒAI è¾¨è­˜ã€';
                document.getElementById('analyzeBtn').classList.remove('hidden'); // é¡¯ç¤ºè¾¨è­˜éˆ•
                document.getElementById('saveBtn').classList.add('hidden');       // éš±è—å„²å­˜éˆ•
                
                // æ¸…ç©ºæ¬„ä½ï¼Œé¿å…æ··æ·†
                document.getElementById('name').value = "";
                document.getElementById('company').value = "";
                document.getElementById('phone1').value = "";
                document.getElementById('phone2').value = "";
                document.getElementById('email').value = "";
            };
            reader.readAsDataURL(file);
        });

        // éšæ®µä¸€ï¼šå‘¼å«å¾Œç«¯ AI é€²è¡Œè¾¨è­˜
        function analyzeImage() {
            if(!document.getElementById('imageBase64').value) {
                alert("è«‹å…ˆé¸æ“‡åœ–ç‰‡ï¼");
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerHTML = '<span class="loader inline-block mr-2"></span>AI åˆ†æä¸­...';

            const data = {
                action: 'analyze', // å‘Šè¨´å¾Œç«¯ï¼šæˆ‘åªè¦åˆ†æï¼Œä¸è¦å­˜æª”
                image: document.getElementById('imageBase64').value,
                fileName: `card_${Date.now()}.png`
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(response => {
                if(response.result === 'success') {
                    // 1. è¨˜ä½å¾Œç«¯å›å‚³çš„åœ–ç‰‡ç¶²å€ (ç­‰ç­‰å„²å­˜è¦ç”¨)
                    currentFileUrl = response.fileUrl;
                    
                    // 2. æŠŠ AI çœ‹åˆ°çš„è³‡æ–™å¡«å…¥æ ¼å­
                    const ai = response.aiData;
                    document.getElementById('name').value = ai.name || "";
                    document.getElementById('company').value = ai.company || "";
                    document.getElementById('phone1').value = ai.phone1 || "";
                    document.getElementById('phone2').value = ai.phone2 || "";
                    document.getElementById('email').value = ai.email || "";

                    document.getElementById('ocr-status').innerText = 'âœ… åˆ†æå®Œæˆï¼è«‹æª¢æŸ¥ä¸¦ä¿®æ”¹è³‡æ–™';
                    
                    // 3. åˆ‡æ›æŒ‰éˆ•ï¼šéš±è—è¾¨è­˜éˆ•ï¼Œé¡¯ç¤ºå„²å­˜éˆ•
                    btn.classList.add('hidden');
                    document.getElementById('saveBtn').classList.remove('hidden');
                } else {
                    alert('âŒ åˆ†æå¤±æ•—: ' + response.error);
                    document.getElementById('ocr-status').innerText = 'âŒ åˆ†æå¤±æ•—';
                }
            })
            .catch(err => {
                console.error(err);
                alert('âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Script ç¶²å€');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = originalText;
            });
        }

        // éšæ®µäºŒï¼šç¢ºèªè³‡æ–™ç„¡èª¤ï¼Œæ­£å¼å¯«å…¥ Google Sheet
        function saveFinalData() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerHTML = '<span class="loader inline-block mr-2"></span>å„²å­˜ä¸­...';

            const data = {
                action: 'save', // å‘Šè¨´å¾Œç«¯ï¼šæˆ‘è¦å­˜æª”
                fileUrl: currentFileUrl, // å‚³é€å‰›å‰›åˆ†æå¥½çš„åœ–ç‰‡ç¶²å€
                name: document.getElementById('name').value, // å‚³é€ä½¿ç”¨è€…å¯èƒ½ä¿®æ”¹éçš„è³‡æ–™
                company: document.getElementById('company').value,
                phone1: document.getElementById('phone1').value,
                phone2: document.getElementById('phone2').value,
                email: document.getElementById('email').value,
                remarks: document.getElementById('remarks').value
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(response => {
                if(response.result === 'success') {
                    alert('ğŸ‰ è³‡æ–™å·²æˆåŠŸå„²å­˜è‡³ Google Sheetï¼');
                    location.reload(); // é‡æ–°æ•´ç†é é¢ï¼Œæº–å‚™ä¸‹ä¸€å¼µ
                } else {
                    alert('âŒ å„²å­˜å¤±æ•—: ' + response.error);
                }
            })
            .catch(err => {
                alert('âŒ é€£ç·šéŒ¯èª¤');
                console.error(err);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = originalText;
            });
        }
    </script>
</body>
</html>



